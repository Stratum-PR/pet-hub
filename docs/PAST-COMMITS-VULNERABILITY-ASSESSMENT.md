# Past Commits – Vulnerability Assessment

**Date:** 2026-02-16  
**Scope:** Commits that still contain issues fixed in the (uncommitted) security hardening pass.

---

## Summary

**All commits up to and including the current `main` tip (`53b52d9`) contain the vulnerabilities listed below.**  
The fixes exist only in your **working tree**; they are not yet committed. Once you commit and push the security changes, new builds from `main` will be remediated.

---

## Affected Commits and Branches

| Branch / ref   | Tip commit | Status |
|----------------|------------|--------|
| `main`         | `53b52d9`  | Vulnerable (fixes not committed) |
| `origin/main`  | `53b52d9`  | Vulnerable |
| `remotes/origin/oauth-v1` | (not checked) | Check if it includes `53b52d9` or older |

**Vulnerable range:** Every commit that contains the affected files in their pre-fix form. In practice this includes at least:

- **53b52d9** (2026-02-18) – current `main` tip
- **ebab16a** (2026-02-18) – introduced ReceiptPrint and current InventoryProductForm file-upload behavior
- All ancestors of these on `main`

---

## Vulnerabilities Present in Past Commits

### 1. XSS in receipt print (medium)

- **File:** `src/components/ReceiptPrint.tsx`
- **In commits:** `ebab16a`, `53b52d9`
- **Issue:** Use of `document.write()` and `div.innerHTML = ...` with receipt data. User-controlled content (business name, header/footer, line item names, tax labels) was escaped with `escapeHtml()` but the patterns are flagged as XSS vectors.
- **Fix (in tree):** Receipt HTML is built as an escaped string and opened via a `data:text/html` URL; no `document.write` or `innerHTML` in code.

### 2. Console and error handling in production (low / informational)

- **Files:** `Layout.tsx`, `PetList.tsx`, `useTransactions.ts`, `translations.ts`, `Pricing.tsx`
- **Issue:** `console.log` / `console.error` / `console.warn` run in production; in Pricing, the caught `error` object is logged (could expose stack traces or internal messages to anyone with DevTools).
- **Fix (in tree):** All such logging guarded with `if (import.meta.env.DEV)` or equivalent; Pricing does not show `error.message` to the user.

### 3. File upload validation (medium)

- **File:** `src/components/InventoryProductForm.tsx`
- **In commits:** At least `ebab16a`, `53b52d9`
- **Issue:** File input `type="file"` with `accept="image/*"` but no client-side MIME allowlist or max size check before passing the file to parent/upload.
- **Fix (in tree):** Client-side check for allowed types (e.g. image/jpeg, image/png, image/webp, image/gif) and max size (e.g. 5MB); user-facing error on violation.

### 4. Pre-commit false positives (tooling only)

- **File:** `scripts/pre-commit`
- **Issue:** File-upload check triggered on any file containing the substring `"file"` (e.g. "profile", "on file"), causing warnings for `Layout.tsx` and `translations.ts`.
- **Fix (in tree):** Upload check only runs when the file contains actual upload patterns (`type="file"`, `storage.from(`, `.upload(`, `supabase.storage`).

---

## Recommended Actions

1. **Commit and push the security fixes** (no `--no-verify`):
   - Commit all modified files that implement the fixes above.
   - Push to `origin/main` so new deployments are from a fixed revision.

2. **Deployments:**
   - Any deployment from a commit before the security-fix commit (e.g. from `53b52d9` or earlier) still has the issues above. Re-deploy from `main` after the fix is pushed.

3. **Other branches:**
   - If you deploy or build from `remotes/origin/oauth-v1` or any other branch, check whether that branch includes the same vulnerable code (e.g. ReceiptPrint, InventoryProductForm, Layout, Pricing). If it does, merge the security fixes or cherry-pick the fix commit.

4. **Tags / releases:**
   - There are no version tags in the repo. If you later tag releases, tag only from a commit that includes the security fixes so “released” versions are not vulnerable.

---

## Verification After Pushing Fixes

- Run the pre-commit hook on the new commit: it should report fewer (or no) failures for the items above.
- Confirm in the deployed app: receipt print, file upload in inventory product form, and that production builds do not log sensitive data to the console.
